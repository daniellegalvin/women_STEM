---
title: "Analysis that works"
author: "Danielle Galvin"
date: "3/1/2022"
output: html_document
---

```{r}
library(brms)
library(tidyverse)
library(tidybayes)
library(wesanderson)
```


```{r}
data <- read.csv("WSTEM_data.csv")
head(data)

gender_data <- data %>% 
  mutate(gender=case_when(gender=="male" ~ "male",
                           gender=="unknown" ~ "unknown",
                           TRUE ~ "female")) %>% 
  mutate(position=case_when(position=="tt"~"tt",
                            TRUE ~ "instructor"))

```

Model looking at the three way interaction
```{r}
get_prior(number ~ 1+gender*position*region, data=gender_data, family=poisson, link="log")

triple_mod <- brm(number ~ 1+gender*position*region,
                  family=poisson(link="log"),
                  data=gender_data %>% filter(gender==c("female", "male")),
                  prior=c(prior(normal(0.3,0.3), class="b"),
                          prior(normal(-0.2, 0.3), class="b", coef="regionRM"),
                          prior(normal(-2,0.3), class="b", coef="regionNW"),
                          prior(normal(1,0.5), class="Intercept")),
                  file="triple_mod.RDS",
                  file_refit="on_change",
                  iter=4000, chains=3)


saveRDS(triple_mod, file="triple_mod.RDS")

# plot(conditional_effects(triple_mod))

pp_check(triple_mod, type="stat_grouped", group="gender")
pp_check(triple_mod, type="stat_grouped", group="region")
pp_check(triple_mod, type="stat_grouped", group="position")

```

Making my data longer and calculating some of the necessary values
```{r}
cond_data <- distinct(triple_mod$data) %>% 
  select(-number)

mod_posts <- add_epred_draws(triple_mod, newdata=cond_data)

mod_posts$.row=NULL

test <- mod_posts %>% 
  select(-.chain, -.iteration) %>%
  distinct() %>% 
  pivot_wider(names_from = "gender", values_from = ".epred") %>% 
  mutate(diff = male - female)
```

Calculating creible intervals and other necessary values
```{r}
#Median credible interval for the difference in men and women at each position by region
test %>% 
  group_by(region, position) %>% 
  median_qi(diff)

#Median credible interval for the number of women in each position by region
test %>% 
  group_by(region, position) %>% 
  median_qi(female)

#Median credible interval for the number of men in each position by region
test %>% 
  group_by(region, position) %>% 
  median_qi(male)

#Calculating the differences by regions
tt_diff <- tidy_data %>% 
  mutate(tt_diff=female_tt-male_tt, na.rm=T)

```

Making the plots!
```{r}
all_data <- test %>% 
  pivot_longer(cols=c("female", "male"),
               names_to="gender", 
               values_to="value") %>% 
  ggplot(aes(x=position, y=value, fill=gender))+
  geom_violin()+
  scale_fill_manual(values=wes_palette("Darjeeling1"))+
  # geom_point(data=gender_data %>% filter(gender==c("female", "male")), aes(x=position, y=number),
  #            size=1,
  #            position=position_dodge(width=0.9))+    remove the silence to display the points
  facet_wrap(vars(region))+
  scale_y_log10()+
  labs(x="Position", y="Number of people employed")
all_data
```
















